@using car_lister.Models
@using car_lister.Shared

<div class="photo-picker-container">
    @if (Car != null && Car.Images != null && Car.Images.Count > 0)
    {
        <div class="photo-picker-header">
            <div class="photo-picker-title">
                <span class="oi oi-image"></span>
                <h3>@Title</h3>
            </div>
            <div class="photo-picker-stats">
                <div class="stat-item">
                    <span class="label">Available Photos:</span>
                    <span class="value">@Car.Images.Count</span>
                </div>
                <div class="stat-item">
                    <span class="label">Selected Photos:</span>
                    <span class="value">@(SelectedPhotos.ContainsKey(Car.Id) ? SelectedPhotos[Car.Id].Count : 0)</span>
                </div>
            </div>
        </div>

        <div class="photo-selection-controls">
            <button class="btn btn-sm btn-secondary" @onclick="() => SelectAllPhotos()">
                Select All
            </button>
            <button class="btn btn-sm btn-secondary" @onclick="() => ClearAllPhotos()">
                Clear All
            </button>
        </div>

        <div class="photo-grid">
            @for (int i = 0; i < Car.Images.Count; i++)
            {
                var photoUrl = Car.Images[i];
                var photoIndex = i;
                var isSelected = SelectedPhotos.ContainsKey(Car.Id) && SelectedPhotos[Car.Id].Contains(photoUrl);

                <div class="photo-item @(isSelected ? "selected" : "")" @onclick="() => OnPhotoClick(photoIndex, photoUrl)">
                    <img src="@photoUrl" alt="Car photo @(photoIndex + 1)" />
                    @if (isSelected)
                    {
                        <div class="photo-selected-badge">
                            <span class="oi oi-check"></span>
                        </div>
                    }
                    <div class="photo-hover-overlay">
                        <span class="oi oi-eye"></span>
                    </div>
                    <div class="photo-quick-select" @onclick:stopPropagation="true"
                        @onclick="() => TogglePhotoSelection(photoUrl)">
                        @if (isSelected)
                        {
                            <span class="oi oi-check"></span>
                        }
                        else
                        {
                            <span class="oi oi-plus"></span>
                        }
                    </div>
                </div>
            }
        </div>

        @if (ShowNavigation && OnPrevious.HasDelegate && OnNext.HasDelegate)
        {
            <div class="photo-picker-navigation">
                <button class="btn btn-sm btn-secondary" @onclick="OnPrevious" disabled="@IsPreviousDisabled">
                    <span class="oi oi-chevron-left"></span>
                    Previous
                </button>
                <span class="navigation-counter">@NavigationText</span>
                <button class="btn btn-sm btn-secondary" @onclick="OnNext" disabled="@IsNextDisabled">
                    Next
                    <span class="oi oi-chevron-right"></span>
                </button>
            </div>
        }
    }
    else
    {
        <div class="no-photos-message">
            <div class="empty-state">
                <span class="oi oi-image text-muted fs-1"></span>
                <h3>No photos available</h3>
                <p>This vehicle has no photos to select from.</p>
            </div>
        </div>
    }
</div>

@* Fullscreen Photo Viewer Modal *@
<Modal @ref="photoViewerModal" IsVisible="@isPhotoViewerVisible" IsVisibleChanged="@OnPhotoViewerVisibilityChanged"
    Title="@(Car?.FullTitle ?? "Photo Viewer")" Size="Modal.ModalSize.Large" ShowHeader="true" ShowFooter="true"
    CloseOnBackdropClick="true" CloseOnEscape="true">

    <Body>
        @if (Car != null && Car.Images != null && photoViewerIndex >= 0 && photoViewerIndex < Car.Images.Count)
        {
            <div class="photo-viewer-container">
                <div class="photo-viewer-image-container">
                    <img src="@Car.Images[photoViewerIndex]" alt="@Car.FullTitle" class="photo-viewer-image" />
                </div>

                @if (Car.Images.Count > 1)
                {
                    <div class="photo-viewer-navigation">
                        <button class="btn btn-secondary" @onclick="() => PreviousPhotoViewerImage()"
                            disabled="@(photoViewerIndex == 0)">
                            <span class="oi oi-chevron-left"></span>
                            Previous
                        </button>
                        <span class="photo-counter">@(photoViewerIndex + 1) of @Car.Images.Count</span>
                        <button class="btn btn-secondary" @onclick="() => NextPhotoViewerImage()"
                            disabled="@(photoViewerIndex == Car.Images.Count - 1)">
                            Next
                            <span class="oi oi-chevron-right"></span>
                        </button>
                    </div>

                    <div class="photo-viewer-thumbnails">
                        @for (int i = 0; i < Car.Images.Count; i++)
                        {
                            var index = i;
                            <div class="thumbnail @(photoViewerIndex == index ? "active" : "")"
                                @onclick="() => SelectPhotoViewerImage(index)">
                                <img src="@Car.Images[index]" alt="Thumbnail @(index + 1)" />
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </Body>
    <Footer>
        <div class="photo-viewer-footer">
            @if (Car != null && Car.Images != null && photoViewerIndex >= 0 && photoViewerIndex < Car.Images.Count)
            {
                <button class="btn btn-primary" @onclick="() => TogglePhotoSelection(Car.Images[photoViewerIndex])">
                    @if (SelectedPhotos.ContainsKey(Car.Id) &&
                                    SelectedPhotos[Car.Id].Contains(Car.Images[photoViewerIndex]))
                    {
                        <span class="oi oi-check"></span>
                        <span>Selected</span>
                    }
                    else
                    {
                        <span class="oi oi-plus"></span>
                        <span>Select Photo</span>
                    }
                </button>
            }
            <button class="btn btn-secondary" @onclick="() => ClosePhotoViewer()">
                Close
            </button>
        </div>
    </Footer>
</Modal>

@code {
    [Parameter] public ScrapedCar Car { get; set; } = new();
    [Parameter] public string Title { get; set; } = "Select Photos";
    [Parameter] public Dictionary<string, List<string>> SelectedPhotos { get; set; } = new();
    [Parameter] public EventCallback<Dictionary<string, List<string>>> SelectedPhotosChanged { get; set; }

    // Navigation parameters
    [Parameter] public bool ShowNavigation { get; set; } = false;
    [Parameter] public EventCallback OnPrevious { get; set; }
    [Parameter] public EventCallback OnNext { get; set; }
    [Parameter] public bool IsPreviousDisabled { get; set; } = false;
    [Parameter] public bool IsNextDisabled { get; set; } = false;
    [Parameter] public string NavigationText { get; set; } = "";

    // Fullscreen viewer parameters
    [Parameter] public bool ShowFullscreenViewer { get; set; } = true;

    // Modal reference and state
    private Modal? photoViewerModal;
    private bool isPhotoViewerVisible = false;
    private int photoViewerIndex = -1;

    private void TogglePhotoSelection(string photoUrl)
    {
        if (Car == null || string.IsNullOrEmpty(Car.Id))
            return;

        if (!SelectedPhotos.ContainsKey(Car.Id))
            SelectedPhotos[Car.Id] = new List<string>();

        if (SelectedPhotos[Car.Id].Contains(photoUrl))
        {
            SelectedPhotos[Car.Id].Remove(photoUrl);
        }
        else
        {
            SelectedPhotos[Car.Id].Add(photoUrl);
        }

        SelectedPhotosChanged.InvokeAsync(SelectedPhotos);
        StateHasChanged();
    }

    private void SelectAllPhotos()
    {
        if (Car == null || string.IsNullOrEmpty(Car.Id) || Car.Images == null)
            return;

        SelectedPhotos[Car.Id] = new List<string>(Car.Images);
        SelectedPhotosChanged.InvokeAsync(SelectedPhotos);
        StateHasChanged();
    }

    private void ClearAllPhotos()
    {
        if (Car == null || string.IsNullOrEmpty(Car.Id))
            return;

        SelectedPhotos[Car.Id] = new List<string>();
        SelectedPhotosChanged.InvokeAsync(SelectedPhotos);
        StateHasChanged();
    }

    private async Task OnPhotoClick(int photoIndex, string photoUrl)
    {
        if (ShowFullscreenViewer)
        {
            photoViewerIndex = photoIndex;
            isPhotoViewerVisible = true;
            if (photoViewerModal != null)
            {
                await photoViewerModal.Show();
            }
        }
        else
        {
            TogglePhotoSelection(photoUrl);
        }
    }

    private async Task ClosePhotoViewer()
    {
        photoViewerIndex = -1;
        isPhotoViewerVisible = false;
        if (photoViewerModal != null)
        {
            await photoViewerModal.Hide();
        }
    }

    private async Task OnPhotoViewerVisibilityChanged(bool isVisible)
    {
        isPhotoViewerVisible = isVisible;
        if (!isVisible)
        {
            photoViewerIndex = -1;
        }
        await Task.CompletedTask;
    }

    private async Task PreviousPhotoViewerImage()
    {
        if (Car != null && Car.Images != null && photoViewerIndex > 0)
        {
            photoViewerIndex--;
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task NextPhotoViewerImage()
    {
        if (Car != null && Car.Images != null && photoViewerIndex < Car.Images.Count - 1)
        {
            photoViewerIndex++;
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task SelectPhotoViewerImage(int index)
    {
        if (Car != null && Car.Images != null && index >= 0 && index < Car.Images.Count)
        {
            photoViewerIndex = index;
            StateHasChanged();
        }
        await Task.CompletedTask;
    }
}
