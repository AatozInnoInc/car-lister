rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Deny access by default
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Rules for the cars collection
    match /cars/{carId} {
      // Allow read for all authenticated users
      allow read: if request.auth != null;
      
      // Allow create if the user is authenticated and they're creating a car listing
      allow create: if request.auth != null && 
                   request.auth.uid == request.resource.data.userId;
      
      // Allow update if the user is authenticated and they own the car listing
      allow update: if request.auth != null && 
                   request.auth.uid == resource.data.userId &&
                   request.auth.uid == request.resource.data.userId;
      
      // Allow delete if the user is authenticated and they own the car listing
      allow delete: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
    }
    
    // Rules for the dealers collection
    match /dealers/{dealerId} {
      // Allow read for all authenticated users
      allow read: if request.auth != null;
      
      // Allow create, update, delete for all authenticated users (admin functionality)
      allow create, update, delete: if request.auth != null;
    }
    
    // Function to validate car data structure
    function validCar(car) {
      return car.size() >= 5 &&                    // Must have at least 5 fields
             car.userId is string &&               // userId must be string
             car.make is string &&                 // make must be string
             car.model is string &&                // model must be string
             car.year is number &&                 // year must be number
             car.price is number &&                // price must be number
             car.createdAt is timestamp &&         // createdAt must be timestamp
             (!('description' in car) || 
              car.description is string) &&        // description must be string if present
             (!('mileage' in car) || 
              car.mileage is number) &&            // mileage must be number if present
             (!('images' in car) || 
              car.images is list);                 // images must be list if present
    }
  }
} 