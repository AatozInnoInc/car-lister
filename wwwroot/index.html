<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Car Lister</title>
        <meta name="description" content="Find your perfect ride or sell your car with ease" />
        <meta name="theme-color" content="#007bff" />
        <base href="/" />
        <link rel="stylesheet" href="css/app.css" />

        <link rel="stylesheet" href="css/navmenu.css" />
        <link rel="stylesheet" href="css/authlayout.css" />
        <link rel="stylesheet" href="css/login.css" />
        <link rel="icon" type="image/png" href="images/car-lister-favicon.png" />
        <link rel="manifest" href="manifest.webmanifest" />
        <link rel="apple-touch-icon" href="images/car-lister-favicon.png" />
        <!-- If you add any scoped CSS files, uncomment the following to load them
	    <link href="car_lister.styles.css" rel="stylesheet" /> -->
    </head>

    <body>
        <div id="app">
            <svg class="loading-progress">
                <circle r="40%" cx="50%" cy="50%" />
                <circle r="40%" cx="50%" cy="50%" />
            </svg>
            <div class="loading-progress-text"></div>
        </div>

        <div id="blazor-error-ui">
            An unhandled error has occurred.
            <a href="" class="reload">Reload</a>
            <a class="dismiss">ðŸ—™</a>
        </div>

        <!-- Firebase scripts first -->
        <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore-compat.js"></script>

        <!-- JSZip for image downloads -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

        <script>
            const currentHost = window.location.hostname;
            const isLocalhost = currentHost === 'localhost' || currentHost === '127.0.0.1';

            // For localhost, we need to use the firebaseapp.com domain for auth
            // For production, we can use either domain
            const authDomain = isLocalhost ? "car-lister-be093.firebaseapp.com" : "car-lister-be093.web.app";

            const firebaseConfig = {
                apiKey: "AIzaSyDXflKHASqzAR05HCvgOLIa20_RkGgfooY",
                authDomain: authDomain,
                projectId: "car-lister-be093",
                storageBucket: "car-lister-be093.firebasestorage.app",
                messagingSenderId: "452093902586",
                appId: "1:452093902586:web:eab1ddd14cdac37404d343"
            };

            // Initialize Firebase
            try {
                firebase.initializeApp(firebaseConfig);
                // Initialize Firestore
                const db = firebase.firestore();

                // Add initialization check
                window.firebaseInitialized = true;

                // Handle Firebase auth redirect (fallback for when popup is blocked)
                window.RedirectHandler = {
                    handleRedirect: async function () {
                        try {
                            console.log('RedirectHandler: Current URL:', window.location.href);

                            // Check if this is a Firebase auth redirect
                            if (window.location.href.includes('/__/auth/')) {
                                console.log('RedirectHandler: Detected Firebase auth redirect, waiting for Firebase to initialize...');

                                // Wait for Firebase to be ready
                                let attempts = 0;
                                while (!window.firebaseInitialized && attempts < 50) {
                                    await new Promise(resolve => setTimeout(resolve, 100));
                                    attempts++;
                                }

                                if (window.firebaseInitialized) {
                                    console.log('RedirectHandler: Firebase ready:', window.firebaseInitialized);
                                    console.log('RedirectHandler: Handling redirect result...');

                                    // Handle the redirect result
                                    const result = await firebase.auth().getRedirectResult();
                                    if (result.user) {
                                        console.log('RedirectHandler: User authenticated:', result.user.email);
                                        // Redirect to the main app
                                        window.location.href = '/';
                                    } else {
                                        console.log('RedirectHandler: No user in redirect result, redirecting to login');
                                        window.location.href = '/login';
                                    }
                                } else {
                                    console.log('RedirectHandler: Firebase not ready, redirecting to login');
                                    window.location.href = '/login';
                                }
                            }
                        } catch (error) {
                            console.error('RedirectHandler: Error handling redirect:', error);
                            window.location.href = '/login';
                        }
                    }
                };

                // Set up authentication state listener
                firebase.auth().onAuthStateChanged(function (user) {
                    if (user) {
                        // Notify Blazor about authentication state change
                        if (window.Blazor && window.Blazor._internal && window.Blazor._internal.dotNetDispatcher) {
                            try {
                                window.Blazor._internal.dotNetDispatcher.invokeDotNetFromJS('car_lister', 'Services.FirebaseAuthenticationStateProvider', 'NotifyAuthenticationStateChanged', []);
                            } catch (error) {
                                // Blazor not ready yet
                            }
                        }
                    }
                });

                // Handle redirect on page load
                window.RedirectHandler.handleRedirect();

            } catch (error) {
                console.error('Firebase initialization error:', error);
                window.firebaseInitialized = false;
            }
        </script>

        <!-- Custom Firebase interface scripts -->
        <script src="js/firebaseAuth.js"></script>
        <script src="js/firestore.js"></script>
        <script src="js/notifications.js"></script>
        <script src="js/modalPortal.js"></script>

        <!-- Blazor script last -->
        <script src="_framework/blazor.webassembly.js"></script>
        <script>
            // Register service worker with error handling
            if ('serviceWorker' in navigator) {
                try {
                    navigator.serviceWorker.register('service-worker.js')
                        .then(function (registration) {
                            console.log('Service Worker registered successfully:', registration);
                        })
                        .catch(function (error) {
                            console.log('Service Worker registration failed:', error);
                        });
                } catch (error) {
                    console.log('Service Worker registration error:', error);
                }
            }
        </script>
    </body>

</html>