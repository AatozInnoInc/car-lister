<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Car Lister</title>
        <meta name="description" content="Find your perfect ride or sell your car with ease" />
        <meta name="theme-color" content="#007bff" />
        <base href="/" />
        <link rel="stylesheet" href="css/app.css" />

        <link rel="stylesheet" href="css/navmenu.css" />
        <link rel="stylesheet" href="css/authlayout.css" />
        <link rel="stylesheet" href="css/login.css" />
        <link rel="icon" type="image/png" href="images/car-lister-favicon.png" />
        <link rel="manifest" href="manifest.webmanifest" />
        <link rel="apple-touch-icon" href="images/car-lister-favicon.png" />
        <!-- If you add any scoped CSS files, uncomment the following to load them
	    <link href="car_lister.styles.css" rel="stylesheet" /> -->
    </head>

    <body>
        <div id="app">
            <svg class="loading-progress">
                <circle r="40%" cx="50%" cy="50%" />
                <circle r="40%" cx="50%" cy="50%" />
            </svg>
            <div class="loading-progress-text"></div>
        </div>

        <div id="blazor-error-ui">
            An unhandled error has occurred.
            <a href="" class="reload">Reload</a>
            <a class="dismiss">ðŸ—™</a>
        </div>

        <!-- Firebase scripts first -->
        <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore-compat.js"></script>

        <!-- JSZip for image downloads -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

        <script>
            // CRITICAL: Always use firebaseapp.com for authDomain
            // Using web.app causes the OAuth iframe to load the Blazor app,
            // which triggers authorization checks and breaks the OAuth flow
            const firebaseConfig = {
                apiKey: "AIzaSyDXflKHASqzAR05HCvgOLIa20_RkGgfooY",
                authDomain: "car-lister-be093.firebaseapp.com",
                projectId: "car-lister-be093",
                storageBucket: "car-lister-be093.firebasestorage.app",
                messagingSenderId: "452093902586",
                appId: "1:452093902586:web:eab1ddd14cdac37404d343"
            };

            // Initialize Firebase
            try {
                firebase.initializeApp(firebaseConfig);
                // Initialize Firestore
                const db = firebase.firestore();

                // Add initialization check
                window.firebaseInitialized = true;

                // Track if we've already handled a redirect to prevent loops
                window.redirectHandled = window.redirectHandled || false;

                // Handle Firebase auth redirect (fallback for when popup is blocked)
                window.RedirectHandler = {
                    handleRedirect: async function () {
                        try {
                            // Don't handle if we've already processed a redirect in this session
                            if (window.redirectHandled) {
                                return;
                            }

                            const currentUrl = window.location.href;

                            // IMPORTANT: Do NOT intercept Firebase internal iframe URLs
                            // These are part of the auth flow, not the redirect result
                            if (currentUrl.includes('/__/auth/iframe') || 
                                currentUrl.includes('/__/auth/handler')) {
                                return;
                            }

                            // Only check for redirect result if we have indicators of an OAuth redirect
                            // This prevents interfering with popup-based auth flows
                            const urlParams = new URLSearchParams(window.location.search);
                            const hasOAuthParams = urlParams.has('code') || 
                                                  urlParams.has('state') || 
                                                  window.location.hash.includes('access_token');
                            
                            // Also check if we're coming from a sign-in redirect
                            const isFromRedirect = sessionStorage.getItem('pendingRedirect') === 'true';
                            
                            if (!hasOAuthParams && !isFromRedirect) {
                                return;
                            }

                            const result = await firebase.auth().getRedirectResult();
                            
                            // Clear the pending redirect flag
                            sessionStorage.removeItem('pendingRedirect');
                            
                            // If we got a user from redirect, mark as handled and navigate
                            if (result && result.user) {
                                window.redirectHandled = true;
                                
                                // Don't force navigation if already on a valid page
                                if (window.location.pathname === '/login' || window.location.pathname === '/') {
                                    window.location.href = '/';
                                }
                            } else if (result && result.credential) {
                                // We got a credential but no user (shouldn't happen, but handle it)
                                window.redirectHandled = true;
                            }
                        } catch (error) {
                            console.error('Error handling redirect:', error);
                            sessionStorage.removeItem('pendingRedirect');
                            // Only redirect to login if we're in a clearly broken state
                            if (error.code === 'auth/invalid-api-key' || 
                                error.code === 'auth/app-deleted') {
                                window.location.href = '/login';
                            }
                        }
                    }
                };

                // Set up authentication state listener
                let authStateListenerInitialized = false;
                firebase.auth().onAuthStateChanged(function (user) {
                    if (!authStateListenerInitialized) {
                        authStateListenerInitialized = true;
                        // Don't auto-redirect on first initialization, let Blazor handle routing
                        return;
                    }
                    
                    if (user) {
                        // Notify Blazor about authentication state change
                        if (window.Blazor && window.Blazor._internal && window.Blazor._internal.dotNetDispatcher) {
                            try {
                                window.Blazor._internal.dotNetDispatcher.invokeDotNetFromJS('car_lister', 'Services.FirebaseAuthenticationStateProvider', 'NotifyAuthenticationStateChanged', []);
                            } catch (error) {
                                // Blazor not ready yet
                            }
                        }
                    }
                });

                // Handle redirect on page load (only once per session)
                window.RedirectHandler.handleRedirect();

            } catch (error) {
                console.error('Firebase initialization error:', error);
                window.firebaseInitialized = false;
            }
        </script>

        <!-- Custom Firebase interface scripts -->
        <script src="js/firebaseAuth.js"></script>
        <script src="js/firestore.js"></script>
        <script src="js/notifications.js"></script>
        <script src="js/modalPortal.js"></script>

        <!-- Blazor script last -->
        <script src="_framework/blazor.webassembly.js"></script>
        <script>
            // Register service worker with error handling
            if ('serviceWorker' in navigator) {
                try {
                    navigator.serviceWorker.register('service-worker.js')
                        .then(function (registration) {
                            console.log('Service Worker registered successfully:', registration);
                        })
                        .catch(function (error) {
                            console.log('Service Worker registration failed:', error);
                        });
                } catch (error) {
                    console.log('Service Worker registration error:', error);
                }
            }
        </script>
    </body>

</html>